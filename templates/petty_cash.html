{% extends "layout.html" %}

{% block title %}ثبت تنخواه{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="/static/persian-datepicker.min.css">
{% endblock %}

{% block content %}
<header class="text-center mb-6">
    <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-1">فرم ثبت تنخواه</h1>
    <p class="text-gray-500 text-sm">لطفاً اطلاعات مربوط به تنخواه را وارد کنید.</p>
</header>

<form action="/add_petty_cash" method="post" enctype="multipart/form-data" class="space-y-4">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
            <label for="date_fa" class="block text-sm font-medium text-gray-700">تاریخ:</label>
            <input type="text" id="date_fa" name="date_fa" required
                   class="w-full p-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm"
                   placeholder="1404/01/01">
        </div>
        <div>
            <label for="description" class="block text-sm font-medium text-gray-700">شرح:</label>
            <input type="text" id="description" name="description" required
                   class="w-full p-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm"
                   list="description-list">
            <datalist id="description-list"></datalist>
        </div>
        <div>
            <label for="unit" class="block text-sm font-medium text-gray-700">واحد:</label>
            <input type="text" id="unit" name="unit"
                   class="w-full p-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm"
                   list="unit-list">
            <datalist id="unit-list"></datalist>
        </div>
        <div>
            <label for="amount" class="block text-sm font-medium text-gray-700">مقدار:</label>
            <input type="number" id="amount" name="amount" step="any" required
                   class="w-full p-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm">
        </div>
        <div>
            <label for="unit_price" class="block text-sm font-medium text-gray-700">فی (ریال):</label>
            <input type="number" id="unit_price" name="unit_price" step="any" required
                   class="w-full p-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm">
        </div>
        <div>
            <label for="discount" class="block text-sm font-medium text-gray-700">تخفیف (درصد یا عدد):</label>
            <input type="text" id="discount" name="discount"
                   class="w-full p-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm"
                   placeholder="مثال: 10% یا 100000">
        </div>
        <div class="md:col-span-1">
            <label for="total_amount" class="block text-sm font-medium text-gray-700">مبلغ کل (ریال):</label>
            <input type="text" id="total_amount" name="total_amount"
                   class="w-full p-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm bg-gray-100"
                   readonly>
        </div>
        <div>
            <label for="location" class="block text-sm font-medium text-gray-700">محل استفاده:</label>
            <input type="text" id="location" name="location"
                   class="w-full p-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm"
                   list="location-list">
            <datalist id="location-list"></datalist>
        </div>
        <div>
            <label for="source" class="block text-sm font-medium text-gray-700">محل تامین:</label>
            <input type="text" id="source" name="source"
                   class="w-full p-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm"
                   list="source-list">
            <datalist id="source-list"></datalist>
        </div>
        <div>
            <label for="notes" class="block text-sm font-medium text-gray-700">توضیحات:</label>
            <textarea id="notes" name="notes" rows="3"
                   class="w-full p-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm"></textarea>
        </div>
        <div>
            <label for="invoice_number" class="block text-sm font-medium text-gray-700">شماره فاکتور:</label>
            <input type="text" id="invoice_number" name="invoice_number"
                   class="w-full p-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm">
        </div>
        <div>
            <label for="settlement_status" class="block text-sm font-medium text-gray-700">وضعیت تسویه:</label>
            <select id="settlement_status" name="settlement_status" required
                    class="w-full p-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm">
                <option value="مانده">مانده</option>
                <option value="تسویه شده">تسویه شده</option>
            </select>
        </div>
        <div>
            <label for="payer" class="block text-sm font-medium text-gray-700">پرداخت کننده:</label>
            <select id="payer" name="payer" required
                    class="w-full p-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm">
                {% for user in users %}
                    {% if user.username != 'admin' or session['user']['username'] == 'admin' %}
                        <option value="{{ user.name }}" {% if session['user']['name'] == user.name %}selected{% endif %}>{{ user.name }}</option>
                    {% endif %}
                {% endfor %}
            </select>
        </div>
        <div class="md:col-span-3">
            <label for="receipt_image" class="block text-sm font-medium text-gray-700">عکس رسید:</label>
            <input type="file" id="receipt_image" name="receipt_image" accept="image/jpeg,image/png,image/bmp,application/pdf" capture="environment"
                   class="w-full p-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm">
        </div>
    </div>
    
    <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-2 rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-300">
        ثبت تنخواه
    </button>
</form>

{% endblock %}

{% block scripts_extra %}
<script src="/static/persian-date.min.js"></script>
<script src="/static/persian-datepicker.min.js"></script>
<script>
    $(document).ready(function() {
        $("#date_fa").pDatepicker({
            initialValue: false,
            format: 'YYYY/MM/DD',
            autoClose: true
        });

        const amountInput = $('#amount');
        const unitPriceInput = $('#unit_price');
        const discountInput = $('#discount');
        const totalAmountInput = $('#total_amount');

        // Function to format numbers with commas
        function formatNumber(number) {
            return new Intl.NumberFormat('fa-IR').format(number);
        }

        // Function to remove commas from a number string
        function removeNumberFormatting(string) {
            return string.replace(/,/g, '');
        }

        // Function to calculate and update total amount
        function calculateTotalAmount() {
            const amount = parseFloat(amountInput.val()) || 0;
            const unitPrice = parseFloat(unitPriceInput.val()) || 0;
            const discountValue = discountInput.val();
            let totalAmount = amount * unitPrice;

            if (discountValue) {
                // Check if discount is a percentage
                if (discountValue.includes('%')) {
                    const discountPercent = parseFloat(removeNumberFormatting(discountValue).replace('%', '')) || 0;
                    totalAmount = totalAmount - (totalAmount * (discountPercent / 100));
                } else {
                    // Assume discount is a fixed amount
                    const discountFixed = parseFloat(removeNumberFormatting(discountValue)) || 0;
                    totalAmount = totalAmount - discountFixed;
                }
            }
            
            // Format the number with commas and set the value
            totalAmountInput.val(formatNumber(totalAmount));
        }

        // Add event listeners for keyup and change
        amountInput.on('input', calculateTotalAmount);
        unitPriceInput.on('input', calculateTotalAmount);
        discountInput.on('input', calculateTotalAmount);
        
        // Make total amount editable on double click
        totalAmountInput.prop('readonly', true);
        totalAmountInput.addClass('bg-gray-100'); // Add the initial background color
        
        totalAmountInput.dblclick(function() {
            $(this).prop('readonly', false);
            $(this).removeClass('bg-gray-100');
            // Remove formatting when editing
            const unformattedValue = removeNumberFormatting($(this).val());
            $(this).val(unformattedValue);
        });
        
        // Re-apply formatting on blur
        totalAmountInput.blur(function() {
            $(this).prop('readonly', true);
            $(this).addClass('bg-gray-100');
            const unformattedValue = removeNumberFormatting($(this).val());
            const formattedValue = formatNumber(unformattedValue);
            $(this).val(formattedValue);
        });
        
        // Autocomplete functionality
        const fieldsToAutocomplete = ['description', 'unit', 'location', 'source'];
        fieldsToAutocomplete.forEach(field => {
            fetch(`/autocomplete/petty_cash_field/${field}`)
                .then(response => response.json())
                .then(data => {
                    const datalist = $(`#${field}-list`);
                    datalist.empty();
                    data.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item;
                        datalist.append(option);
                    });
                })
                .catch(error => console.error(`Error fetching autocomplete data for ${field}:`, error));
        });
    });
</script>
{% endblock %}
